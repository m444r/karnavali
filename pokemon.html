<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCKonrzpUnxhZ_e9F5Zvkdx4EW47zrveTk&callback=initMap" async defer></script>


<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps - Add Figure in 100m Range</title>
	
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
    </style>
</head>

<body>
    <h2>Find the Hidden Object!</h2>
    <div id="map"></div>
    <button id="showFigureBtn" onclick="showFigure()" disabled>Show Figure</button>

    <script>
        let map;
        let userMarker;
        let figureMarker; 
        let showFigureMarker;
        let foundFigure = false;
        let figureLocation = null;        //38.272955 ,21.764551 
        const targetLocation = { lat: 38.251591, lng: 21.741044 }; // Example location //spiti: 38.251591,21.741044

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15,
                center: targetLocation
            });

            // Place a marker for the target location
            new google.maps.Marker({
                position: targetLocation,
                map: map,
                title: "Target Location"
            });

            // Get the user's location
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(updateUserLocation, showError, {
                    enableHighAccuracy: true,
                    timeout: 10000,
          			maximumAge: 0
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function updateUserLocation(position) {
            const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            // Remove previous user marker
            if (userMarker) userMarker.setMap(null);

            // Add a new marker for the user
            userMarker = new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "You are here!",
                icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" // Blue dot for user
            });

            // Check distance from target
            const distance = getDistance(userLocation, targetLocation);
            console.log("Distance to target: " + distance + " meters");

            if (distance <= 100) {
               addFigure(targetLocation);
            } else {
                if (figureMarker) figureMarker.setMap(null); // Remove the figure if out of range
            }
        }

        function addFigure(location) {
            if (figureMarker) return; // Don't add another if it already exists

            figureMarker = new google.maps.Marker({
                position: location,
                map: map,
                title: "Hidden Figure!",
                
            });
            foundFigure = true;
            figureLocation = location; // Save location for later
            document.getElementById("showFigureBtn").disabled = false;
            alert("You've discovered a hidden figure!");
            

        }

        function showFigure() {
            if (!foundFigure || !figureLocation) {
                alert("You haven't discovered the figure yet!");
                return;
            }

            if (showFigureMarker) showFigureMarker.setMap(null);

            showFigureMarker = new google.maps.Marker({
                position: figureLocation,
                map: map,
                icon: "https://cdn-icons-png.flaticon.com/128/4193/4193257.png"
            });

            map.setCenter(figureLocation); // Move the map to the figure
        }


        function getDistance(loc1, loc2) {
            const R = 6371000; // Earth radius in meters
            const dLat = (loc2.lat - loc1.lat) * (Math.PI / 180);
            const dLng = (loc2.lng - loc1.lng) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(loc1.lat * (Math.PI / 180)) * Math.cos(loc2.lat * (Math.PI / 180)) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in meters
        }

        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    alert("User denied the request for Geolocation.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("Location information is unavailable.");
                    break;
                case error.TIMEOUT:
                    alert("The request to get user location timed out.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("An unknown error occurred.");
                    break;
            }
        }
        

    </script>
</body>
</html>
